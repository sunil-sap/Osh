/**
 * 
 */
package com.hybris.osh.core.dao.impl;

import de.hybris.platform.core.PK;
import de.hybris.platform.core.model.link.LinkModel;
import de.hybris.platform.core.model.media.MediaContainerModel;
import de.hybris.platform.core.model.media.MediaModel;
import de.hybris.platform.mediaconversion.constants.MediaConversionConstants;
import de.hybris.platform.mediaconversion.job.DefaultMediaConversionJobDao;
import de.hybris.platform.mediaconversion.model.ConversionMediaFormatModel;
import de.hybris.platform.mediaconversion.model.job.MediaConversionCronJobModel;
import de.hybris.platform.servicelayer.search.FlexibleSearchQuery;

import java.util.Arrays;
import java.util.Collection;
import java.util.List;
import java.util.Map;
import java.util.TreeMap;


public class OshMediaConversionJobDao extends DefaultMediaConversionJobDao
{
	@Override
	public Collection<List<PK>> queryFormatsPerContainerToConvert(final MediaConversionCronJobModel cronJob)
	{
		final Map<String, Object> params = this.queryParams(cronJob);
		// params are set by super class
		@SuppressWarnings("deprecation")
		final FlexibleSearchQuery query = new FlexibleSearchQuery( //

				"SELECT un.container, un.format " + //
						"FROM ( " + //

						// medias that are missing:
						"{{" + "SELECT sub.container, sub.format FROM ({{" + //
						"SELECT {a." + MediaContainerModel.PK + "} AS container, " + //
						"{f." + ConversionMediaFormatModel.PK + "} AS format, " + //
						"{m." + MediaModel.PK + "} AS media " + //
						"FROM {" + MediaContainerModel._TYPECODE + " AS a " + //
						"LEFT JOIN " + MediaConversionConstants.Relations.CONVERSIONGROUPTOFORMATREL + " AS tf " + //
						"ON {a." + MediaContainerModel.CONVERSIONGROUP + "} = {tf." + LinkModel.SOURCE + "} " + //
						"JOIN " + ConversionMediaFormatModel._TYPECODE + " AS f " + //
						"ON ({a." + MediaContainerModel.CONVERSIONGROUP + "} IS NULL " + //
						"OR {tf." + LinkModel.TARGET + "} = {f." + ConversionMediaFormatModel.PK + "}) " + //
						"LEFT JOIN " + MediaModel._TYPECODE + " AS m " + //
						"ON {m." + MediaModel.MEDIACONTAINER + "} = {a." + MediaContainerModel.PK + "} " + //
						"AND {m." + MediaModel.MEDIAFORMAT + "} = {f." + ConversionMediaFormatModel.PK + "} " + //

						"} " + //
						"WHERE 1 = 1 " + //

						// options
						(params.containsKey(DefaultMediaConversionJobDao.MEDIAFORMATS_PARAMETER) ? //
						"AND {f." + ConversionMediaFormatModel.PK + "} IN " + //
								"(?" + DefaultMediaConversionJobDao.MEDIAFORMATS_PARAMETER + ") "
								: "") + //
						(params.containsKey(DefaultMediaConversionJobDao.CATALOGVERSION_PARAMETER) ? //
						"AND {a." + MediaContainerModel.CATALOGVERSION + "} = " + //
								"?" + DefaultMediaConversionJobDao.CATALOGVERSION_PARAMETER + " "
								: "") + //

						"}}) sub " + //deleted AS - not used in ORACLE
						"WHERE sub.media IS NULL " +

						"}} " + //
						"UNION ALL " + //
						"{{" + //
						this.outdatedMediaQuery(params) + "}} " + //
						") un " + // deleted AS - not used in ORACLE
						"ORDER BY un.container", //

				params);
		query.setResultClassList(Arrays.asList(new Class[]
		{ PK.class, PK.class }));

		return this.getFlexibleSearchService().<List<PK>> search(query).getResult();
	}

	Map queryParams(final MediaConversionCronJobModel cronJob)
	{
		final Map params = new TreeMap();
		if (cronJob.getIncludedFormats() != null && !cronJob.getIncludedFormats().isEmpty())
		{
			params.put("formats", cronJob.getIncludedFormats());
		}
		if (cronJob.getCatalogVersion() != null)
		{
			params.put("catVersion", cronJob.getCatalogVersion());
		}
		return params;
	}

	private String outdatedMediaQuery(final Map params)
	{
		return (new StringBuilder(
				"SELECT {ua.pk} AS container, {cm.mediaFormat} AS format FROM {MediaContainer AS ua JOIN Media as cm ON {cm.mediaContainer} = {ua.pk} JOIN ConversionMediaFormat as cmf ON {cm.mediaFormat} = {cmf.pk} LEFT JOIN Media as om ON {om.mediaContainer} = {ua.pk} AND {om.pk} = {cm.original} } WHERE {cm.originalDataPK} IS NOT NULL AND ({om.dataPK} IS NULL OR {cm.originalDataPK} <> {om.dataPK}) "))
				.append(params.containsKey("formats") ? "AND {cm.mediaFormat} IN (?formats) " : "")
				.append(params.containsKey("catVersion") ? "AND {ua.catalogVersion} = ?catVersion " : "").toString();
	}
}